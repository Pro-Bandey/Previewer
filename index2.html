<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GitHub File Previewer v2.0</title>

<!-- PrismJS for syntax highlighting -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/themes/prism.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/themes/prism-tomorrow.min.css" rel="stylesheet" id="dark-theme" disabled/>

<style>
  :root {
    --bg: #fff;
    --fg: #333;
    --accent: #007bff;
  }
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--bg);
    color: var(--fg);
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: var(--accent);
    color: #fff;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  header h1 { margin: 0; font-size: 18px; }
  header button { padding: 5px 10px; cursor: pointer; }

  #form-section {
    padding: 10px 20px;
    background: #f0f0f0;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }
  #urlInput { flex: 1; padding: 5px; min-width: 250px; }
  #previewBtn { padding: 5px 10px; cursor: pointer; }

  #main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }
  #previewFrame {
    flex: 1;
    border: none;
  }
  #codeViewer {
    width: 50%;
    max-width: 600px;
    overflow: auto;
    border-left: 1px solid #ccc;
    background: #1e1e1e;
    color: #fff;
    display: none;
    flex-direction: column;
  }
  pre { margin: 0; padding: 10px; }
  #fileType { margin-left: 10px; font-size: 0.9em; }
  #history { margin-left: 10px; font-size: 0.9em; cursor: pointer; }
</style>
</head>
<body>

<header>
  <h1>GitHub File Previewer v2.0</h1>
  <div>
    <button id="toggleTheme">Toggle Dark/Light</button>
    <button id="toggleCode">Toggle Code</button>
  </div>
</header>

<div id="form-section">
  <input type="url" id="urlInput" placeholder="Paste GitHub/BitBucket file URL here" autofocus>
  <button id="previewBtn">Preview</button>
  <span id="fileType"></span>
  <span id="history" title="View preview history">ðŸ“œ</span>
</div>

<div id="main">
  <iframe id="previewFrame" sandbox="allow-scripts allow-same-origin"></iframe>
  <div id="codeViewer"><pre><code id="codeContent" class="language-markup"></code></pre></div>
</div>

<!-- PrismJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-markup.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-markdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-bash.min.js"></script>

<script>
(() => {
  const urlInput = document.getElementById('urlInput');
  const previewBtn = document.getElementById('previewBtn');
  const previewFrame = document.getElementById('previewFrame');
  const codeViewer = document.getElementById('codeViewer');
  const codeContent = document.getElementById('codeContent');
  const toggleCode = document.getElementById('toggleCode');
  const toggleTheme = document.getElementById('toggleTheme');
  const fileTypeLabel = document.getElementById('fileType');
  const historyBtn = document.getElementById('history');

  const darkThemeLink = document.getElementById('dark-theme');

  let history = JSON.parse(localStorage.getItem('previewHistory') || '[]');

  const detectFileType = url => {
    const ext = url.split('.').pop().toLowerCase();
    if (['html','htm'].includes(ext)) return 'html';
    if (['css'].includes(ext)) return 'css';
    if (['js','mjs'].includes(ext)) return 'javascript';
    if (['md','markdown'].includes(ext)) return 'markdown';
    if (['json'].includes(ext)) return 'json';
    if (['csv','tsv'].includes(ext)) return 'csv';
    if (['txt','log'].includes(ext)) return 'text';
    if (['svg','png','jpg','jpeg','gif','webp'].includes(ext)) return 'image';
    return 'text';
  };

  const fetchFile = async url => {
    const rawUrl = url
      .replace(/\/\/github\.com/, '//raw.githubusercontent.com')
      .replace(/\/blob\//, '/');
    const proxies = ['', 'https://api.codetabs.com/v1/proxy/?quest='];

    for (let i = 0; i < proxies.length; i++) {
      try {
        const res = await fetch(proxies[i] + rawUrl);
        if (!res.ok) throw new Error(res.statusText);
        return await res.text();
      } catch(e) {
        if (i === proxies.length - 1) throw e;
      }
    }
  };

  const showPreview = async () => {
    const url = urlInput.value.trim();
    if(!url) return;

    const type = detectFileType(url);
    fileTypeLabel.textContent = `Type: ${type.toUpperCase()}`;

    history.unshift(url);
    localStorage.setItem('previewHistory', JSON.stringify(history.slice(0, 20)));

    if (['html'].includes(type)) {
      const content = await fetchFile(url);
      const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
      iframeDoc.open();
      iframeDoc.write(content);
      iframeDoc.close();

      codeContent.textContent = content;
      codeContent.className = 'language-markup';
      Prism.highlightAll();
      codeViewer.style.display = 'block';
    } else if (['css','javascript','json','markdown','text','csv'].includes(type)) {
      const content = await fetchFile(url);
      previewFrame.srcdoc = `<pre>${content.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</pre>`;
      codeContent.textContent = content;
      codeContent.className = 'language-' + (type==='text'?'markup':type);
      Prism.highlightAll();
      codeViewer.style.display = 'block';
    } else if (['image','svg'].includes(type)) {
      previewFrame.srcdoc = `<img src="${url}" style="max-width:100%;height:auto;">`;
      codeContent.textContent = `Image URL:\n${url}`;
      codeContent.className = 'language-markup';
      Prism.highlightAll();
      codeViewer.style.display = 'block';
    } else {
      previewFrame.srcdoc = `<pre>${content}</pre>`;
      codeContent.textContent = content;
      codeViewer.style.display = 'block';
    }
  };

  previewBtn.addEventListener('click', showPreview);
  urlInput.addEventListener('keypress', e => { if(e.key==='Enter') showPreview(); });

  toggleCode.addEventListener('click', () => {
    codeViewer.style.display = codeViewer.style.display==='flex'?'none':'flex';
  });

  toggleTheme.addEventListener('click', () => {
    darkThemeLink.disabled = !darkThemeLink.disabled;
  });

  historyBtn.addEventListener('click', () => {
    alert('Preview History:\n' + (history.length ? history.join('\n') : 'No history yet'));
  });

})();
</script>

</body>
</html>
