<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Universal File Previewer — CSV, VCF, TXT, MD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <!-- Highlight.js for syntax highlighting -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <!-- Icons (optional) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
  <style>
    :root {
      --bg: #0f1218;
      --bg-soft: #141824;
      --bg-softer: #1a2030;
      --text: #e6e9ef;
      --muted: #a9b0be;
      --primary: #6ea8fe;
      --accent: #7bd389;
      --danger: #ff6b6b;
      --warning: #f7b267;
      --border: #2a3244;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    [data-theme="light"] {
      --bg: #f7f9fc;
      --bg-soft: #ffffff;
      --bg-softer: #f0f3f8;
      --text: #1b2430;
      --muted: #4b5565;
      --primary: #1f6feb;
      --accent: #2ea043;
      --danger: #d73a49;
      --warning: #d29922;
      --border: #d0d7de;
      --shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }

    /* Layout */
    .app {
      display: grid;
      grid-template-rows: auto auto 1fr;
      grid-template-columns: 260px 1fr;
      grid-template-areas:
        "topbar topbar"
        "toolbar toolbar"
        "sidebar main";
      height: 100vh;
    }

    .topbar {
      grid-area: topbar;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--bg-soft);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      letter-spacing: 0.2px;
    }
    .brand .logo {
      width: 28px; height: 28px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      box-shadow: var(--shadow);
    }
    .actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-softer);
      color: var(--text);
      cursor: pointer;
      transition: transform 0.08s ease, background 0.2s ease, border-color 0.2s ease;
    }
    .btn:hover { transform: translateY(-1px); background: var(--bg-soft) }
    .btn.primary { background: var(--primary); border-color: transparent; color: #fff }
    .btn.accent { background: var(--accent); border-color: transparent; color: #0b1a0f }
    .btn.danger { background: var(--danger); border-color: transparent; color: #fff }
    .btn.ghost { background: transparent }
    .btn:active { transform: translateY(0) }

    .toolbar {
      grid-area: toolbar;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg-soft);
      border-bottom: 1px solid var(--border);
    }
    .toolbar .search-all {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--bg-softer);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
    }
    .toolbar input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 14px;
    }

    .sidebar {
      grid-area: sidebar;
      border-right: 1px solid var(--border);
      background: var(--bg-soft);
      display: flex;
      flex-direction: column;
      min-width: 240px;
    }
    .sidebar .panel {
      padding: 12px 12px;
      border-bottom: 1px solid var(--border);
    }
    .sidebar h3 {
      margin: 0 0 8px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    .meta-list {
      display: grid;
      gap: 8px;
    }
    .meta-item {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: var(--muted);
    }
    .file-list {
      flex: 1;
      overflow: auto;
    }
    .file-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    .file-item:hover { background: var(--bg-softer) }
    .file-item .name { flex: 1 }
    .file-item .type {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
    }

    .main {
      grid-area: main;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Tabs */
    .tabs {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 8px 0;
      background: var(--bg-soft);
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
    }
    .tab {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 8px 8px 0 0;
      background: var(--bg-softer);
      border: 1px solid var(--border);
      border-bottom: none;
      cursor: grab;
      user-select: none;
      min-width: 160px;
    }
    .tab.active {
      background: var(--bg);
      color: var(--text);
      box-shadow: var(--shadow);
    }
    .tab .close {
      cursor: pointer;
      color: var(--muted);
    }
    .tab .close:hover { color: var(--danger) }

    .content {
      flex: 1;
      overflow: auto;
      background: var(--bg);
      padding: 16px;
      position: relative;
    }

    /* Dropzone */
    .dropzone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      color: var(--muted);
      transition: border-color 0.2s ease, background 0.2s ease;
    }
    .dropzone.dragover {
      border-color: var(--primary);
      background: var(--bg-softer);
    }

    /* Context menu */
    .context-menu {
      position: fixed;
      background: var(--bg-soft);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: var(--shadow);
      min-width: 180px;
      z-index: 1000;
      display: none;
    }
    .context-menu .item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }
    .context-menu .item:last-child { border-bottom: none }
    .context-menu .item:hover { background: var(--bg-softer) }

    /* CSV table */
    table.csv {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    table.csv th, table.csv td {
      border-bottom: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 14px;
    }
    table.csv th {
      background: var(--bg-softer);
      position: sticky;
      top: 0;
      z-index: 1;
      cursor: pointer;
      user-select: none;
    }
    .table-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
    }
    .table-controls input, .table-controls select {
      background: var(--bg-softer);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 8px;
      outline: none;
    }

    /* TXT viewer */
    .txt-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .txt-stats {
      color: var(--muted);
      font-size: 13px;
    }
    pre.code {
      background: var(--bg-softer);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      overflow: auto;
      font-size: var(--code-size, 14px);
    }

    /* Markdown editor */
    .md-split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .md-editor, .md-preview {
      background: var(--bg-softer);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: auto;
      padding: 12px;
    }
    .md-editor textarea {
      width: 100%;
      height: 60vh;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 14px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .md-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    /* Responsive */
    @media (max-width: 980px) {
      .app {
        grid-template-columns: 1fr;
        grid-template-areas:
          "topbar"
          "toolbar"
          "main";
      }
      .sidebar { display: none }
      .md-split { grid-template-columns: 1fr }
    }
  </style>
</head>
<body>
  <div class="app" id="app" data-theme="dark">
    <!-- Topbar -->
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>Universal File Previewer</div>
      </div>
      <div class="actions">
        <label class="btn">
          <i class="ti ti-file-plus"></i>
          <span>Open files</span>
          <input id="fileInput" type="file" multiple hidden accept=".csv,.vcf,.txt,.md,.json,.html,.css,.js,.xml,.yml,.yaml,.ini,.log,.ts,.tsx,.jsx,.mdx,.conf,.config,.env,.text" />
        </label>
        <button class="btn" id="toggleTheme"><i class="ti ti-sun"></i><span>Theme</span></button>
        <button class="btn" id="settingsBtn"><i class="ti ti-settings"></i><span>Settings</span></button>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="search-all">
        <i class="ti ti-search"></i>
        <input id="globalSearch" type="search" placeholder="Search across all open files…" />
        <button class="btn ghost" id="clearSearch"><i class="ti ti-x"></i></button>
      </div>
      <div class="dropzone" id="dropzone">Drag & drop files here (CSV, VCF, TXT, MD)</div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="panel">
        <h3>File info</h3>
        <div class="meta-list" id="metaList">
          <!-- Populated dynamically -->
        </div>
      </div>
      <div class="panel">
        <h3>Open files</h3>
      </div>
      <div class="file-list" id="fileList">
        <!-- Populated dynamically -->
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="tabs" id="tabs"></div>
      <div class="content" id="content"></div>
    </main>
  </div>

  <!-- Context menu -->
  <div class="context-menu" id="contextMenu">
    <div class="item" data-action="rename"><i class="ti ti-edit"></i> Rename</div>
    <div class="item" data-action="download"><i class="ti ti-download"></i> Download</div>
    <div class="item" data-action="copy"><i class="ti ti-copy"></i> Copy</div>
    <div class="item" data-action="close"><i class="ti ti-x"></i> Close</div>
    <div class="item" data-action="delete"><i class="ti ti-trash"></i> Delete</div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

  <script>
    // ============================================================
    // Utility helpers
    // ============================================================
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
    const uid = () => Math.random().toString(36).slice(2, 10);

    const fileTypeFromName = (name, content = "") => {
      const ext = (name.split('.').pop() || '').toLowerCase();
      if (['csv'].includes(ext)) return 'csv';
      if (['vcf', 'vcard'].includes(ext)) return 'vcf';
      if (['md', 'markdown', 'mdx'].includes(ext)) return 'md';
      if (['txt', 'log', 'ini', 'conf', 'config', 'env'].includes(ext)) return 'txt';
      if (['json', 'html', 'css', 'js', 'xml', 'yml', 'yaml', 'ts', 'tsx', 'jsx'].includes(ext)) return 'txt';
      // Content sniffing fallback
      if (/^#\s|^##\s|^\*\s|^\-\s|```/.test(content)) return 'md';
      if (/BEGIN:VCARD/i.test(content)) return 'vcf';
      if (/,/.test(content) && /\n/.test(content)) return 'csv';
      return 'txt';
    };

    const downloadBlob = (blob, filename) => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    const escapeHTML = (str) => str.replace(/[&<>"']/g, s => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[s]));

    // ============================================================
    // State
    // ============================================================
    const state = {
      tabs: [],           // {id, name, type, content, parsed, meta}
      activeId: null,
      settings: {
        theme: localStorage.getItem('ufp-theme') || 'dark',
        fontSize: parseInt(localStorage.getItem('ufp-fontSize') || '14', 10),
      },
      drag: { draggingId: null },
      searchAll: '',
    };

    // Apply theme from settings
    const appEl = $('#app');
    appEl.dataset.theme = state.settings.theme;

    // ============================================================
    // Rendering
    // ============================================================
    function render() {
      renderTabs();
      renderContent();
      renderSidebar();
    }

    function renderTabs() {
      const tabsEl = $('#tabs');
      tabsEl.innerHTML = '';
      state.tabs.forEach((t, idx) => {
        const tab = document.createElement('div');
        tab.className = 'tab' + (t.id === state.activeId ? ' active' : '');
        tab.draggable = true;
        tab.dataset.id = t.id;
        tab.innerHTML = `
          <i class="ti ti-file"></i>
          <span class="title">${escapeHTML(t.name)}</span>
          <span class="type">${t.type.toUpperCase()}</span>
          <span class="close"><i class="ti ti-x"></i></span>
        `;
        // Drag reorder
        tab.addEventListener('dragstart', (e) => {
          state.drag.draggingId = t.id;
          e.dataTransfer.effectAllowed = 'move';
        });
        tab.addEventListener('dragover', (e) => e.preventDefault());
        tab.addEventListener('drop', (e) => {
          e.preventDefault();
          const fromId = state.drag.draggingId;
          const toId = t.id;
          if (!fromId || fromId === toId) return;
          const fromIdx = state.tabs.findIndex(x => x.id === fromId);
          const toIdx = state.tabs.findIndex(x => x.id === toId);
          const [moved] = state.tabs.splice(fromIdx, 1);
          state.tabs.splice(toIdx, 0, moved);
          state.drag.draggingId = null;
          renderTabs();
        });
        tab.addEventListener('click', (e) => {
          if (e.target.closest('.close')) {
            closeTab(t.id);
          } else {
            setActive(t.id);
          }
        });
        tab.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          openContextMenu(e.clientX, e.clientY, t.id);
        });
        tabsEl.appendChild(tab);
      });
    }

    function renderSidebar() {
      const fileList = $('#fileList');
      fileList.innerHTML = '';
      state.tabs.forEach(t => {
        const item = document.createElement('div');
        item.className = 'file-item';
        item.dataset.id = t.id;
        item.innerHTML = `
          <i class="ti ti-file"></i>
          <div class="name">${escapeHTML(t.name)}</div>
          <div class="type">${t.type.toUpperCase()}</div>
        `;
        item.addEventListener('click', () => setActive(t.id));
        item.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          openContextMenu(e.clientX, e.clientY, t.id);
        });
        fileList.appendChild(item);
      });

      const metaList = $('#metaList');
      metaList.innerHTML = '';
      const active = state.tabs.find(t => t.id === state.activeId);
      if (!active) return;
      const meta = active.meta || {};
      const entries = [
        ['Name', active.name],
        ['Type', active.type.toUpperCase()],
        ['Size', meta.size ? `${meta.size} bytes` : '—'],
        ['Lines', meta.lines ?? '—'],
        ['Words', meta.words ?? '—'],
        ['Last modified', meta.lastModified ? new Date(meta.lastModified).toLocaleString() : '—'],
      ];
      entries.forEach(([k, v]) => {
        const row = document.createElement('div');
        row.className = 'meta-item';
        row.innerHTML = `<div>${k}</div><div>${escapeHTML(String(v))}</div>`;
        metaList.appendChild(row);
      });
    }

    function renderContent() {
      const content = $('#content');
      content.innerHTML = '';
      const active = state.tabs.find(t => t.id === state.activeId);
      if (!active) {
        content.innerHTML = `
          <div style="max-width:720px;margin:40px auto;text-align:center;color:var(--muted)">
            <h2 style="margin:0 0 8px">No file open</h2>
            <p>Use the "Open files" button or drag & drop files into the dropzone above.</p>
          </div>
        `;
        return;
      }
      if (active.type === 'csv') {
        content.appendChild(renderCSVView(active));
      } else if (active.type === 'vcf') {
        content.appendChild(renderVCFView(active));
      } else if (active.type === 'md') {
        content.appendChild(renderMDView(active));
      } else {
        content.appendChild(renderTXTView(active));
      }
    }

    // ============================================================
    // CSV View
    // ============================================================
    function renderCSVView(tab) {
      const wrap = document.createElement('div');

      // Controls
      const controls = document.createElement('div');
      controls.className = 'table-controls';
      controls.innerHTML = `
        <input type="search" placeholder="Filter rows…" class="csv-filter" />
        <label><input type="checkbox" class="csv-headers" ${tab.parsed?.meta?.fields?.length ? 'checked' : ''}/> Headers</label>
        <button class="btn" data-action="export"><i class="ti ti-file-export"></i> Export CSV</button>
      `;
      wrap.appendChild(controls);

      // Table
      const table = document.createElement('table');
      table.className = 'csv';
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');
      table.appendChild(thead);
      table.appendChild(tbody);
      wrap.appendChild(table);

      // Build data
      const parsed = tab.parsed || Papa.parse(tab.content, { header: true, skipEmptyLines: true });
      tab.parsed = parsed;

      let rows = parsed.data;
      let fields = parsed.meta.fields && parsed.meta.fields.length ? parsed.meta.fields : Object.keys(rows[0] || {});
      let useHeaders = parsed.meta.fields && parsed.meta.fields.length > 0;

      const renderHead = () => {
        thead.innerHTML = '';
        const tr = document.createElement('tr');
        fields.forEach((f, idx) => {
          const th = document.createElement('th');
          th.textContent = useHeaders ? f : `Column ${idx + 1}`;
          th.dataset.field = f;
          th.addEventListener('click', () => {
            const asc = th.dataset.sort !== 'asc';
            rows.sort((a, b) => {
              const va = (a[f] ?? '').toString();
              const vb = (b[f] ?? '').toString();
              return asc ? va.localeCompare(vb, undefined, { numeric: true }) : vb.localeCompare(va, undefined, { numeric: true });
            });
            $$('th', thead).forEach(x => x.dataset.sort = '');
            th.dataset.sort = asc ? 'asc' : 'desc';
            renderBody();
          });
          tr.appendChild(th);
        });
        thead.appendChild(tr);
      };

      const renderBody = () => {
        tbody.innerHTML = '';
        rows.forEach((row, rIdx) => {
          const tr = document.createElement('tr');
          fields.forEach((f, cIdx) => {
            const td = document.createElement('td');
            td.contentEditable = 'true';
            td.textContent = row[f] ?? '';
            td.addEventListener('input', () => {
              row[f] = td.textContent;
            });
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      };

      renderHead();
      renderBody();

      // Filter
      const filterInput = $('.csv-filter', controls);
      filterInput.addEventListener('input', () => {
        const q = filterInput.value.toLowerCase();
        rows = parsed.data.filter(row =>
          fields.some(f => String(row[f] ?? '').toLowerCase().includes(q))
        );
        renderBody();
      });

      // Toggle headers
      const headersToggle = $('.csv-headers', controls);
      headersToggle.addEventListener('change', () => {
        useHeaders = headersToggle.checked;
        renderHead();
        renderBody();
      });

      // Export
      const exportBtn = $('[data-action="export"]', controls);
      exportBtn.addEventListener('click', () => {
        const csv = Papa.unparse(rows, { header: useHeaders, columns: fields });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        downloadBlob(blob, tab.name.replace(/\.[^.]+$/, '') + '_export.csv');
      });

      return wrap;
    }

    // ============================================================
    // VCF View
    // ============================================================
    function parseVCF(content) {
      const contacts = [];
      const cards = content.split(/END:VCARD/i).map(x => x.trim()).filter(Boolean);
      for (const card of cards) {
        const lines = card.split(/\r?\n/).map(l => l.trim());
        const contact = {};
        for (const line of lines) {
          if (/^BEGIN:VCARD/i.test(line)) continue;
          const [rawKey, rawVal] = line.split(':', 2);
          if (!rawKey || !rawVal) continue;
          const key = rawKey.split(';')[0].toUpperCase();
          const val = rawVal.trim();
          if (key === 'FN') contact.name = val;
          if (key === 'N') contact.n = val;
          if (key === 'TEL') {
            contact.phone = contact.phone || [];
            contact.phone.push(val);
          }
          if (key === 'EMAIL') {
            contact.email = contact.email || [];
            contact.email.push(val);
          }
          if (key === 'ORG') contact.org = val;
          if (key === 'TITLE') contact.title = val;
          if (key === 'ADR') {
            contact.address = contact.address || [];
            contact.address.push(val);
          }
          if (key === 'URL') contact.url = val;
          if (key === 'NOTE') contact.note = val;
        }
        if (Object.keys(contact).length) contacts.push(contact);
      }
      return contacts;
    }

    function renderVCFView(tab) {
      const wrap = document.createElement('div');
      const controls = document.createElement('div');
      controls.className = 'table-controls';
      controls.innerHTML = `
        <input type="search" placeholder="Search contacts…" class="vcf-filter" />
        <button class="btn" data-action="export-selected"><i class="ti ti-address-book"></i> Export selected</button>
      `;
      wrap.appendChild(controls);

      const list = document.createElement('div');
      list.style.display = 'grid';
      list.style.gridTemplateColumns = 'repeat(auto-fill, minmax(260px, 1fr))';
      list.style.gap = '12px';
      wrap.appendChild(list);

      const contacts = tab.parsed || parseVCF(tab.content);
      tab.parsed = contacts;

      let filtered = contacts.slice();
      const renderCards = () => {
        list.innerHTML = '';
        filtered.forEach((c, idx) => {
          const card = document.createElement('div');
          card.style.background = 'var(--bg-softer)';
          card.style.border = '1px solid var(--border)';
          card.style.borderRadius = '12px';
          card.style.padding = '12px';
          card.style.display = 'grid';
          card.style.gap = '6px';
          card.innerHTML = `
            <label style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" class="vcf-select" data-idx="${idx}">
              <strong>${escapeHTML(c.name || c.n || 'Unnamed')}</strong>
            </label>
            <div class="muted">${escapeHTML(c.title || c.org || '')}</div>
            ${c.phone ? `<div><i class="ti ti-phone"></i> ${c.phone.map(p => escapeHTML(p)).join(', ')}</div>` : ''}
            ${c.email ? `<div><i class="ti ti-mail"></i> ${c.email.map(e => escapeHTML(e)).join(', ')}</div>` : ''}
            ${c.address ? `<div><i class="ti ti-map-pin"></i> ${c.address.map(a => escapeHTML(a)).join('; ')}</div>` : ''}
            ${c.url ? `<div><i class="ti ti-link"></i> <a href="${escapeHTML(c.url)}" target="_blank">${escapeHTML(c.url)}</a></div>` : ''}
            ${c.note ? `<div><i class="ti ti-note"></i> ${escapeHTML(c.note)}</div>` : ''}
          `;
          list.appendChild(card);
        });
      };
      renderCards();

      // Filter
      const filterInput = $('.vcf-filter', controls);
      filterInput.addEventListener('input', () => {
        const q = filterInput.value.toLowerCase();
        filtered = contacts.filter(c =>
          (c.name || c.n || '').toLowerCase().includes(q) ||
          (c.title || '').toLowerCase().includes(q) ||
          (c.org || '').toLowerCase().includes(q) ||
          (c.phone || []).some(p => p.toLowerCase().includes(q)) ||
          (c.email || []).some(e => e.toLowerCase().includes(q))
        );
        renderCards();
      });

      // Export selected
      const exportBtn = $('[data-action="export-selected"]', controls);
      exportBtn.addEventListener('click', () => {
        const selectedIdx = $$('.vcf-select', wrap)
          .filter(cb => cb.checked)
          .map(cb => parseInt(cb.dataset.idx, 10));
        const selected = selectedIdx.map(i => filtered[i]);
        if (!selected.length) return alert('No contacts selected.');
        const vcf = selected.map(c => {
          const lines = ['BEGIN:VCARD', 'VERSION:3.0'];
          if (c.name) lines.push(`FN:${c.name}`);
          if (c.n) lines.push(`N:${c.n}`);
          (c.phone || []).forEach(p => lines.push(`TEL:${p}`));
          (c.email || []).forEach(e => lines.push(`EMAIL:${e}`));
          (c.address || []).forEach(a => lines.push(`ADR:${a}`));
          if (c.org) lines.push(`ORG:${c.org}`);
          if (c.title) lines.push(`TITLE:${c.title}`);
          if (c.url) lines.push(`URL:${c.url}`);
          if (c.note) lines.push(`NOTE:${c.note}`);
          lines.push('END:VCARD');
          return lines.join('\r\n');
        }).join('\r\n');
        const blob = new Blob([vcf], { type: 'text/vcard;charset=utf-8' });
        downloadBlob(blob, tab.name.replace(/\.[^.]+$/, '') + '_selected.vcf');
      });

      return wrap;
    }

    // ============================================================
    // TXT View
    // ============================================================
    function renderTXTView(tab) {
      const wrap = document.createElement('div');

      const controls = document.createElement('div');
      controls.className = 'txt-controls';
      controls.innerHTML = `
        <input type="search" placeholder="Search text…" class="txt-filter" />
        <select class="txt-lang">
          <option value="plaintext">Plain text</option>
          <option value="json">JSON</option>
          <option value="html">HTML</option>
          <option value="css">CSS</option>
          <option value="javascript">JavaScript</option>
          <option value="xml">XML</option>
          <option value="yaml">YAML</option>
        </select>
        <label>Font size
          <input type="range" min="12" max="22" value="${state.settings.fontSize}" class="txt-font">
        </label>
        <span class="txt-stats"></span>
        <button class="btn" data-action="download"><i class="ti ti-download"></i> Download</button>
      `;
      wrap.appendChild(controls);

      const pre = document.createElement('pre');
      pre.className = 'code';
      const code = document.createElement('code');
      code.textContent = tab.content;
      pre.appendChild(code);
      wrap.appendChild(pre);

      // Stats
      const statsEl = $('.txt-stats', controls);
      const lines = tab.content.split(/\r?\n/).length;
      const words = tab.content.trim().split(/\s+/).filter(Boolean).length;
      statsEl.textContent = `Lines: ${lines} • Words: ${words}`;

      // Language select
      const langSel = $('.txt-lang', controls);
      const ext = tab.name.split('.').pop()?.toLowerCase();
      const extMap = { json:'json', html:'html', css:'css', js:'javascript', xml:'xml', yml:'yaml', yaml:'yaml' };
      if (extMap[ext]) langSel.value = extMap[ext];

      // Highlight
      const applyHighlight = () => {
        code.className = '';
        const lang = langSel.value;
        if (lang !== 'plaintext') code.classList.add(lang);
        hljs.highlightElement(code);
      };
      applyHighlight();

      // Font size
      const fontRange = $('.txt-font', controls);
      const applyFontSize = () => {
        pre.style.setProperty('--code-size', fontRange.value + 'px');
        state.settings.fontSize = parseInt(fontRange.value, 10);
        localStorage.setItem('ufp-fontSize', String(state.settings.fontSize));
      };
      applyFontSize();
      fontRange.addEventListener('input', applyFontSize);

      // Filter search
      const filterInput = $('.txt-filter', controls);
      filterInput.addEventListener('input', () => {
        const q = filterInput.value;
        if (!q) {
          code.innerHTML = escapeHTML(tab.content);
          applyHighlight();
          return;
        }
        // Simple highlight: wrap matches
        const safe = escapeHTML(tab.content);
        const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        code.innerHTML = safe.replace(re, m => `<mark style="background:${getComputedStyle(appEl).getPropertyValue('--warning')};color:#000">${m}</mark>`);
      });

      // Download
      const dlBtn = $('[data-action="download"]', controls);
      dlBtn.addEventListener('click', () => {
        const blob = new Blob([tab.content], { type: 'text/plain;charset=utf-8' });
        downloadBlob(blob, tab.name);
      });

      return wrap;
    }

    // ============================================================
    // Markdown View
    // ============================================================
    function renderMDView(tab) {
      const wrap = document.createElement('div');

      const controls = document.createElement('div');
      controls.className = 'md-controls';
      controls.innerHTML = `
        <button class="btn" data-action="export-md"><i class="ti ti-file-export"></i> Export .md</button>
        <span style="color:var(--muted)">Live editor & preview</span>
      `;
      wrap.appendChild(controls);

      const split = document.createElement('div');
      split.className = 'md-split';

      const editor = document.createElement('div');
      editor.className = 'md-editor';
      editor.innerHTML = `<textarea class="md-input">${escapeHTML(tab.content)}</textarea>`;

      const preview = document.createElement('div');
      preview.className = 'md-preview';
      preview.innerHTML = `<div class="md-html"></div>`;

      split.appendChild(editor);
      split.appendChild(preview);
      wrap.appendChild(split);

      const input = $('.md-input', editor);
      const html = $('.md-html', preview);

      // Configure marked + sanitize
      marked.setOptions({
        breaks: true,
        gfm: true,
        headerIds: true,
        mangle: false
      });

      const renderMD = () => {
        const raw = input.value;
        const rendered = marked.parse(raw);
        const safe = DOMPurify.sanitize(rendered, { ADD_ATTR: ['target'] });
        html.innerHTML = safe;
        // Highlight code blocks
        $$('pre code', html).forEach(block => hljs.highlightElement(block));
      };
      renderMD();

      input.addEventListener('input', renderMD);

      // Export
      const exportBtn = $('[data-action="export-md"]', controls);
      exportBtn.addEventListener('click', () => {
        const blob = new Blob([input.value], { type: 'text/markdown;charset=utf-8' });
        const base = tab.name.replace(/\.[^.]+$/, '') || 'document';
        downloadBlob(blob, base + '.md');
      });

      return wrap;
    }

    // ============================================================
    // Tabs management
    // ============================================================
    function addTab({ name, type, content, meta = {} }) {
      const id = uid();
      const tab = { id, name, type, content, meta, parsed: null };
      state.tabs.push(tab);
      setActive(id);
      render();
    }

    function setActive(id) {
      state.activeId = id;
      render();
    }

    function closeTab(id) {
      const idx = state.tabs.findIndex(t => t.id === id);
      if (idx >= 0) {
        state.tabs.splice(idx, 1);
        if (state.activeId === id) {
          state.activeId = state.tabs[idx]?.id || state.tabs[idx - 1]?.id || null;
        }
        render();
      }
    }

    // ============================================================
    // Context menu
    // ============================================================
    const ctxMenu = $('#contextMenu');
    let ctxTargetId = null;

    function openContextMenu(x, y, id) {
      ctxTargetId = id;
      ctxMenu.style.display = 'block';
      const { innerWidth, innerHeight } = window;
      const rect = ctxMenu.getBoundingClientRect();
      const posX = Math.min(x, innerWidth - rect.width - 8);
      const posY = Math.min(y, innerHeight - rect.height - 8);
      ctxMenu.style.left = posX + 'px';
      ctxMenu.style.top = posY + 'px';
    }
    function closeContextMenu() {
      ctxMenu.style.display = 'none';
      ctxTargetId = null;
    }
    document.addEventListener('click', (e) => {
      if (!ctxMenu.contains(e.target)) closeContextMenu();
    });
    ctxMenu.addEventListener('click', (e) => {
      const item = e.target.closest('.item');
      if (!item || !ctxTargetId) return;
      const action = item.dataset.action;
      const tab = state.tabs.find(t => t.id === ctxTargetId);
      if (!tab) return;
      if (action === 'rename') {
        const newName = prompt('Rename file:', tab.name);
        if (newName) tab.name = newName;
      } else if (action === 'download') {
        const blob = new Blob([tab.content], { type: 'text/plain;charset=utf-8' });
        downloadBlob(blob, tab.name);
      } else if (action === 'copy') {
        navigator.clipboard.writeText(tab.content).then(() => {
          alert('File content copied to clipboard.');
        });
      } else if (action === 'close') {
        closeTab(tab.id);
      } else if (action === 'delete') {
        closeTab(tab.id);
      }
      closeContextMenu();
      render();
    });

    // ============================================================
    // Global search across files
    // ============================================================
    const globalSearch = $('#globalSearch');
    const clearSearch = $('#clearSearch');

    globalSearch.addEventListener('input', () => {
      state.searchAll = globalSearch.value.toLowerCase();
      highlightGlobalSearch();
    });
    clearSearch.addEventListener('click', () => {
      globalSearch.value = '';
      state.searchAll = '';
      highlightGlobalSearch();
    });

    function highlightGlobalSearch() {
      const q = state.searchAll;
      // Only highlight in TXT and MD previews for simplicity
      state.tabs.forEach(t => {
        if (t.id !== state.activeId) return;
        const contentEl = $('#content');
        if (!q) {
          renderContent();
          return;
        }
        if (t.type === 'txt') {
          const code = $('pre.code code', contentEl);
          if (!code) return;
          const safe = escapeHTML(t.content);
          const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
          code.innerHTML = safe.replace(re, m => `<mark style="background:${getComputedStyle(appEl).getPropertyValue('--warning')};color:#000">${m}</mark>`);
        } else if (t.type === 'md') {
          const html = $('.md-html', contentEl);
          if (!html) return;
          const safe = escapeHTML(t.content);
          const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
          html.innerHTML = DOMPurify.sanitize(marked.parse(t.content));
          // naive highlight in rendered HTML text nodes
          html.innerHTML = html.innerHTML.replace(re, m => `<mark style="background:${getComputedStyle(appEl).getPropertyValue('--warning')};color:#000">${m}</mark>`);
        }
      });
    }

    // ============================================================
    // Drag & drop + file input
    // ============================================================
    const dropzone = $('#dropzone');
    const fileInput = $('#fileInput');

    ['dragenter','dragover'].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      });
    });
    ['dragleave','drop'].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
      });
    });
    dropzone.addEventListener('drop', async (e) => {
      const files = Array.from(e.dataTransfer.files || []);
      await openFiles(files);
    });

    fileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      await openFiles(files);
      fileInput.value = '';
    });

    async function openFiles(files) {
      for (const file of files) {
        const text = await file.text();
        const type = fileTypeFromName(file.name, text);
        const meta = {
          size: file.size,
          lastModified: file.lastModified,
          lines: text.split(/\r?\n/).length,
          words: text.trim().split(/\s+/).filter(Boolean).length,
        };
        addTab({ name: file.name, type, content: text, meta });
      }
    }

    // ============================================================
    // Settings & theme
    // ============================================================
    const toggleThemeBtn = $('#toggleTheme');
    toggleThemeBtn.addEventListener('click', () => {
      const next = appEl.dataset.theme === 'dark' ? 'light' : 'dark';
      appEl.dataset.theme = next;
      state.settings.theme = next;
      localStorage.setItem('ufp-theme', next);
      renderContent();
    });

    // Simple settings modal (inline prompt for brevity)
    $('#settingsBtn').addEventListener('click', () => {
      const theme = prompt('Theme (dark/light):', state.settings.theme) || state.settings.theme;
      const fontSize = parseInt(prompt('Code font size (12–22):', String(state.settings.fontSize)) || state.settings.fontSize, 10);
      appEl.dataset.theme = theme === 'light' ? 'light' : 'dark';
      state.settings.theme = appEl.dataset.theme;
      state.settings.fontSize = Math.min(22, Math.max(12, fontSize));
      localStorage.setItem('ufp-theme', state.settings.theme);
      localStorage.setItem('ufp-fontSize', String(state.settings.fontSize));
      renderContent();
    });

    // ============================================================
    // Keyboard shortcuts
    // ============================================================
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd+Tab: next tab
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'tab') {
        e.preventDefault();
        const idx = state.tabs.findIndex(t => t.id === state.activeId);
        if (idx >= 0) {
          const next = state.tabs[(idx + 1) % state.tabs.length];
          setActive(next.id);
        }
      }
      // Ctrl/Cmd+Shift+Tab: previous tab
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'tab') {
        e.preventDefault();
        const idx = state.tabs.findIndex(t => t.id === state.activeId);
        if (idx >= 0) {
          const prev = state.tabs[(idx - 1 + state.tabs.length) % state.tabs.length];
          setActive(prev.id);
        }
      }
      // Ctrl/Cmd+F: focus global search
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
        e.preventDefault();
        globalSearch.focus();
      }
    });

    // Initial render
    render();
  </script>
</body>
</html>
